#!/bin/sh

# Write erlang cookie
#
# This script grabs the value of ERLANG_COOKIE from
# the environment, defaulting to 'insecure-cookie',
# then echoing the value to ~/.erlang.cookie.
#
# It also sets the appropriate ownership and
# permissions required by the erlang VM.
#
# Defaults to enable unless disabled provided as the
# first argument.

: ${ERLANG_COOKIE:=insecure-cookie}
cookie_path=~/.erlang.cookie

get_user()
{
    if getent passwd "$(basename $HOME)" > /dev/null 2>&1
    then
        basename "$HOME"
    elif getent passwd $(whoami) > /dev/null 2>&1
    then
        whoami
    fi
}

enable()
{
    local user=$(get_user)

    [ "$ERLANG_COOKIE" = insecure-cookie ] && echo "*** INSECURE ERLANG COOKIE ***" >&2
    echo "$ERLANG_COOKIE" > $cookie_path
    chown -R $user:$user ~
    chmod 0600 $cookie_path
}

disable()
{
    [ -f "$cookie_path" ] && rm -f $cookie_path
}

if [ "$1" ]
then
    "$@"
else
    enable
fi

